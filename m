Return-Path: <nouveau-bounces@lists.freedesktop.org>
X-Original-To: lists+nouveau@lfdr.de
Delivered-To: lists+nouveau@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 5C3965B4C8
	for <lists+nouveau@lfdr.de>; Mon,  1 Jul 2019 08:21:06 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id C260389F55;
	Mon,  1 Jul 2019 06:21:04 +0000 (UTC)
X-Original-To: nouveau@lists.freedesktop.org
Delivered-To: nouveau@lists.freedesktop.org
Received: from bombadil.infradead.org (bombadil.infradead.org
 [IPv6:2607:7c80:54:e::133])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 2181D89F4F;
 Mon,  1 Jul 2019 06:21:04 +0000 (UTC)
Received: from [46.140.178.35] (helo=localhost)
 by bombadil.infradead.org with esmtpsa (Exim 4.92 #3 (Red Hat Linux))
 id 1hhpgS-000378-TW; Mon, 01 Jul 2019 06:21:01 +0000
From: Christoph Hellwig <hch@lst.de>
To: Dan Williams <dan.j.williams@intel.com>,
 =?UTF-8?q?J=C3=A9r=C3=B4me=20Glisse?= <jglisse@redhat.com>,
 Jason Gunthorpe <jgg@mellanox.com>, Ben Skeggs <bskeggs@redhat.com>
Date: Mon,  1 Jul 2019 08:20:15 +0200
Message-Id: <20190701062020.19239-18-hch@lst.de>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20190701062020.19239-1-hch@lst.de>
References: <20190701062020.19239-1-hch@lst.de>
MIME-Version: 1.0
X-SRS-Rewrite: SMTP reverse-path rewritten from <hch@infradead.org> by
 bombadil.infradead.org. See http://www.infradead.org/rpr.html
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; q=dns/txt;
 c=relaxed/relaxed; 
 d=infradead.org; s=bombadil.20170209; h=Content-Transfer-Encoding:
 MIME-Version:References:In-Reply-To:Message-Id:Date:Subject:Cc:To:From:Sender
 :Reply-To:Content-Type:Content-ID:Content-Description:Resent-Date:Resent-From
 :Resent-Sender:Resent-To:Resent-Cc:Resent-Message-ID:List-Id:List-Help:
 List-Unsubscribe:List-Subscribe:List-Post:List-Owner:List-Archive;
 bh=xUI/EXwYMJaY9l3WyYSFkVG5FXgw0dlvM8RM5YUiHCA=; b=Q0gERuJMvNOrp605GuN4cJ1M8w
 FIWV4ebIUv6FBI3RY/e9YoYafpWH8qEf36FhZ1B+JT7Lzpe4jPJL0TyLoNYOIwAom5YkX90KIuBAs
 FCugeikJCBhSKewcpz4To0UewCYUuIlsx7xLlx9M/bCud13VHfjJdX3WnlwyfBQOQqv92W2L7jRK1
 OJYaYMw2MbFgd0Erln9j+jgBlpOSfBGM14S2KmssLIaGJ3lCUt9NFfFu1MSupYKHkAIis4WsOFQRQ
 IjT7S7CTC1KGyYOfrttiuICeDichO+8M5mqi65JiG5+plXAX58GbkAo6wlxHfeSulbPRc96eSgRfI
 Oxq3mJqQ==;
Subject: [Nouveau] [PATCH 17/22] mm/hmm: Fix error flows in
 hmm_invalidate_range_start
X-BeenThere: nouveau@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Nouveau development list <nouveau.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/nouveau>,
 <mailto:nouveau-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/nouveau>
List-Post: <mailto:nouveau@lists.freedesktop.org>
List-Help: <mailto:nouveau-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/nouveau>,
 <mailto:nouveau-request@lists.freedesktop.org?subject=subscribe>
Cc: Philip Yang <Philip.Yang@amd.com>, Ralph Campbell <rcampbell@nvidia.com>,
 linux-nvdimm@lists.01.org, linux-pci@vger.kernel.org,
 linux-kernel@vger.kernel.org, dri-devel@lists.freedesktop.org,
 linux-mm@kvack.org, nouveau@lists.freedesktop.org,
 Ira Weiny <ira.weiny@intel.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: nouveau-bounces@lists.freedesktop.org
Sender: "Nouveau" <nouveau-bounces@lists.freedesktop.org>

RnJvbTogSmFzb24gR3VudGhvcnBlIDxqZ2dAbWVsbGFub3guY29tPgoKSWYgdGhlIHRyeWxvY2sg
b24gdGhlIGhtbS0+bWlycm9yc19zZW0gZmFpbHMgdGhlIGZ1bmN0aW9uIHdpbGwgcmV0dXJuCndp
dGhvdXQgZGVjcmVtZW50aW5nIHRoZSBub3RpZmllcnMgdGhhdCB3ZXJlIHByZXZpb3VzbHkgaW5j
cmVtZW50ZWQuIFNpbmNlCnRoZSBjYWxsZXIgd2lsbCBub3QgY2FsbCBpbnZhbGlkYXRlX3Jhbmdl
X2VuZCgpIG9uIEVBR0FJTiB0aGlzIHdpbGwgcmVzdWx0CmluIG5vdGlmaWVycyBiZWNvbWluZyBw
ZXJtYW5lbnRseSBpbmNyZW1lbnRlZCBhbmQgZGVhZGxvY2suCgpJZiB0aGUgc3luY19jcHVfZGV2
aWNlX3BhZ2V0YWJsZXMoKSByZXF1aXJlZCBibG9ja2luZyB0aGUgZnVuY3Rpb24gd2lsbApub3Qg
cmV0dXJuIEVBR0FJTiBldmVuIHRob3VnaCB0aGUgZGV2aWNlIGNvbnRpbnVlcyB0byB0b3VjaCB0
aGUKcGFnZXMuIFRoaXMgaXMgYSB2aW9sYXRpb24gb2YgdGhlIG1tdSBub3RpZmllciBjb250cmFj
dC4KClN3aXRjaCwgYW5kIHJlbmFtZSwgdGhlIHJhbmdlc19sb2NrIHRvIGEgc3BpbiBsb2NrIHNv
IHdlIGNhbiByZWxpYWJseQpvYnRhaW4gaXQgd2l0aG91dCBibG9ja2luZyBkdXJpbmcgZXJyb3Ig
dW53aW5kLgoKVGhlIGVycm9yIHVud2luZCBpcyBuZWNlc3Nhcnkgc2luY2UgdGhlIG5vdGlmaWVy
cyBjb3VudCBtdXN0IGJlIGhlbGQKaW5jcmVtZW50ZWQgYWNyb3NzIHRoZSBjYWxsIHRvIHN5bmNf
Y3B1X2RldmljZV9wYWdldGFibGVzKCkgYXMgd2UgY2Fubm90CmFsbG93IHRoZSByYW5nZSB0byBi
ZWNvbWUgbWFya2VkIHZhbGlkIGJ5IGEgcGFyYWxsZWwKaW52YWxpZGF0ZV9zdGFydC9lbmQoKSBw
YWlyIHdoaWxlIGRvaW5nIHN5bmNfY3B1X2RldmljZV9wYWdldGFibGVzKCkuCgpTaWduZWQtb2Zm
LWJ5OiBKYXNvbiBHdW50aG9ycGUgPGpnZ0BtZWxsYW5veC5jb20+ClJldmlld2VkLWJ5OiBSYWxw
aCBDYW1wYmVsbCA8cmNhbXBiZWxsQG52aWRpYS5jb20+ClJldmlld2VkLWJ5OiBDaHJpc3RvcGgg
SGVsbHdpZyA8aGNoQGxzdC5kZT4KVGVzdGVkLWJ5OiBQaGlsaXAgWWFuZyA8UGhpbGlwLllhbmdA
YW1kLmNvbT4KLS0tCiBpbmNsdWRlL2xpbnV4L2htbS5oIHwgIDIgKy0KIG1tL2htbS5jICAgICAg
ICAgICAgfCA2OSArKysrKysrKysrKysrKysrKysrKysrKysrKy0tLS0tLS0tLS0tLS0tLS0tLS0K
IDIgZmlsZXMgY2hhbmdlZCwgNDEgaW5zZXJ0aW9ucygrKSwgMzAgZGVsZXRpb25zKC0pCgpkaWZm
IC0tZ2l0IGEvaW5jbHVkZS9saW51eC9obW0uaCBiL2luY2x1ZGUvbGludXgvaG1tLmgKaW5kZXgg
YmYwMTNlOTY1MjU3Li4wZmE4ZWEzNGNjZWYgMTAwNjQ0Ci0tLSBhL2luY2x1ZGUvbGludXgvaG1t
LmgKKysrIGIvaW5jbHVkZS9saW51eC9obW0uaApAQCAtODYsNyArODYsNyBAQAogc3RydWN0IGht
bSB7CiAJc3RydWN0IG1tX3N0cnVjdAkqbW07CiAJc3RydWN0IGtyZWYJCWtyZWY7Ci0Jc3RydWN0
IG11dGV4CQlsb2NrOworCXNwaW5sb2NrX3QJCXJhbmdlc19sb2NrOwogCXN0cnVjdCBsaXN0X2hl
YWQJcmFuZ2VzOwogCXN0cnVjdCBsaXN0X2hlYWQJbWlycm9yczsKIAlzdHJ1Y3QgbW11X25vdGlm
aWVyCW1tdV9ub3RpZmllcjsKZGlmZiAtLWdpdCBhL21tL2htbS5jIGIvbW0vaG1tLmMKaW5kZXgg
YjIyNGVhNjM1YTc3Li5kZTM1Mjg5ZGYyMGQgMTAwNjQ0Ci0tLSBhL21tL2htbS5jCisrKyBiL21t
L2htbS5jCkBAIC02NCw3ICs2NCw3IEBAIHN0YXRpYyBzdHJ1Y3QgaG1tICpobW1fZ2V0X29yX2Ny
ZWF0ZShzdHJ1Y3QgbW1fc3RydWN0ICptbSkKIAlpbml0X3J3c2VtKCZobW0tPm1pcnJvcnNfc2Vt
KTsKIAlobW0tPm1tdV9ub3RpZmllci5vcHMgPSBOVUxMOwogCUlOSVRfTElTVF9IRUFEKCZobW0t
PnJhbmdlcyk7Ci0JbXV0ZXhfaW5pdCgmaG1tLT5sb2NrKTsKKwlzcGluX2xvY2tfaW5pdCgmaG1t
LT5yYW5nZXNfbG9jayk7CiAJa3JlZl9pbml0KCZobW0tPmtyZWYpOwogCWhtbS0+bm90aWZpZXJz
ID0gMDsKIAlobW0tPm1tID0gbW07CkBAIC0xNDQsNiArMTQ0LDI1IEBAIHN0YXRpYyB2b2lkIGht
bV9yZWxlYXNlKHN0cnVjdCBtbXVfbm90aWZpZXIgKm1uLCBzdHJ1Y3QgbW1fc3RydWN0ICptbSkK
IAlobW1fcHV0KGhtbSk7CiB9CiAKK3N0YXRpYyB2b2lkIG5vdGlmaWVyc19kZWNyZW1lbnQoc3Ry
dWN0IGhtbSAqaG1tKQoreworCXVuc2lnbmVkIGxvbmcgZmxhZ3M7CisKKwlzcGluX2xvY2tfaXJx
c2F2ZSgmaG1tLT5yYW5nZXNfbG9jaywgZmxhZ3MpOworCWhtbS0+bm90aWZpZXJzLS07CisJaWYg
KCFobW0tPm5vdGlmaWVycykgeworCQlzdHJ1Y3QgaG1tX3JhbmdlICpyYW5nZTsKKworCQlsaXN0
X2Zvcl9lYWNoX2VudHJ5KHJhbmdlLCAmaG1tLT5yYW5nZXMsIGxpc3QpIHsKKwkJCWlmIChyYW5n
ZS0+dmFsaWQpCisJCQkJY29udGludWU7CisJCQlyYW5nZS0+dmFsaWQgPSB0cnVlOworCQl9CisJ
CXdha2VfdXBfYWxsKCZobW0tPndxKTsKKwl9CisJc3Bpbl91bmxvY2tfaXJxcmVzdG9yZSgmaG1t
LT5yYW5nZXNfbG9jaywgZmxhZ3MpOworfQorCiBzdGF0aWMgaW50IGhtbV9pbnZhbGlkYXRlX3Jh
bmdlX3N0YXJ0KHN0cnVjdCBtbXVfbm90aWZpZXIgKm1uLAogCQkJY29uc3Qgc3RydWN0IG1tdV9u
b3RpZmllcl9yYW5nZSAqbnJhbmdlKQogewpAQCAtMTUxLDYgKzE3MCw3IEBAIHN0YXRpYyBpbnQg
aG1tX2ludmFsaWRhdGVfcmFuZ2Vfc3RhcnQoc3RydWN0IG1tdV9ub3RpZmllciAqbW4sCiAJc3Ry
dWN0IGhtbV9taXJyb3IgKm1pcnJvcjsKIAlzdHJ1Y3QgaG1tX3VwZGF0ZSB1cGRhdGU7CiAJc3Ry
dWN0IGhtbV9yYW5nZSAqcmFuZ2U7CisJdW5zaWduZWQgbG9uZyBmbGFnczsKIAlpbnQgcmV0ID0g
MDsKIAogCWlmICgha3JlZl9nZXRfdW5sZXNzX3plcm8oJmhtbS0+a3JlZikpCkBAIC0xNjEsMTIg
KzE4MSw3IEBAIHN0YXRpYyBpbnQgaG1tX2ludmFsaWRhdGVfcmFuZ2Vfc3RhcnQoc3RydWN0IG1t
dV9ub3RpZmllciAqbW4sCiAJdXBkYXRlLmV2ZW50ID0gSE1NX1VQREFURV9JTlZBTElEQVRFOwog
CXVwZGF0ZS5ibG9ja2FibGUgPSBtbXVfbm90aWZpZXJfcmFuZ2VfYmxvY2thYmxlKG5yYW5nZSk7
CiAKLQlpZiAobW11X25vdGlmaWVyX3JhbmdlX2Jsb2NrYWJsZShucmFuZ2UpKQotCQltdXRleF9s
b2NrKCZobW0tPmxvY2spOwotCWVsc2UgaWYgKCFtdXRleF90cnlsb2NrKCZobW0tPmxvY2spKSB7
Ci0JCXJldCA9IC1FQUdBSU47Ci0JCWdvdG8gb3V0OwotCX0KKwlzcGluX2xvY2tfaXJxc2F2ZSgm
aG1tLT5yYW5nZXNfbG9jaywgZmxhZ3MpOwogCWhtbS0+bm90aWZpZXJzKys7CiAJbGlzdF9mb3Jf
ZWFjaF9lbnRyeShyYW5nZSwgJmhtbS0+cmFuZ2VzLCBsaXN0KSB7CiAJCWlmICh1cGRhdGUuZW5k
IDwgcmFuZ2UtPnN0YXJ0IHx8IHVwZGF0ZS5zdGFydCA+PSByYW5nZS0+ZW5kKQpAQCAtMTc0LDcg
KzE4OSw3IEBAIHN0YXRpYyBpbnQgaG1tX2ludmFsaWRhdGVfcmFuZ2Vfc3RhcnQoc3RydWN0IG1t
dV9ub3RpZmllciAqbW4sCiAKIAkJcmFuZ2UtPnZhbGlkID0gZmFsc2U7CiAJfQotCW11dGV4X3Vu
bG9jaygmaG1tLT5sb2NrKTsKKwlzcGluX3VubG9ja19pcnFyZXN0b3JlKCZobW0tPnJhbmdlc19s
b2NrLCBmbGFncyk7CiAKIAlpZiAobW11X25vdGlmaWVyX3JhbmdlX2Jsb2NrYWJsZShucmFuZ2Up
KQogCQlkb3duX3JlYWQoJmhtbS0+bWlycm9yc19zZW0pOwpAQCAtMTgyLDE2ICsxOTcsMjMgQEAg
c3RhdGljIGludCBobW1faW52YWxpZGF0ZV9yYW5nZV9zdGFydChzdHJ1Y3QgbW11X25vdGlmaWVy
ICptbiwKIAkJcmV0ID0gLUVBR0FJTjsKIAkJZ290byBvdXQ7CiAJfQorCiAJbGlzdF9mb3JfZWFj
aF9lbnRyeShtaXJyb3IsICZobW0tPm1pcnJvcnMsIGxpc3QpIHsKLQkJaW50IHJldDsKKwkJaW50
IHJjOwogCi0JCXJldCA9IG1pcnJvci0+b3BzLT5zeW5jX2NwdV9kZXZpY2VfcGFnZXRhYmxlcyht
aXJyb3IsICZ1cGRhdGUpOwotCQlpZiAoIXVwZGF0ZS5ibG9ja2FibGUgJiYgcmV0ID09IC1FQUdB
SU4pCisJCXJjID0gbWlycm9yLT5vcHMtPnN5bmNfY3B1X2RldmljZV9wYWdldGFibGVzKG1pcnJv
ciwgJnVwZGF0ZSk7CisJCWlmIChyYykgeworCQkJaWYgKFdBUk5fT04odXBkYXRlLmJsb2NrYWJs
ZSB8fCByYyAhPSAtRUFHQUlOKSkKKwkJCQljb250aW51ZTsKKwkJCXJldCA9IC1FQUdBSU47CiAJ
CQlicmVhazsKKwkJfQogCX0KIAl1cF9yZWFkKCZobW0tPm1pcnJvcnNfc2VtKTsKIAogb3V0Ogor
CWlmIChyZXQpCisJCW5vdGlmaWVyc19kZWNyZW1lbnQoaG1tKTsKIAlobW1fcHV0KGhtbSk7CiAJ
cmV0dXJuIHJldDsKIH0KQEAgLTIwNCwyMCArMjI2LDcgQEAgc3RhdGljIHZvaWQgaG1tX2ludmFs
aWRhdGVfcmFuZ2VfZW5kKHN0cnVjdCBtbXVfbm90aWZpZXIgKm1uLAogCWlmICgha3JlZl9nZXRf
dW5sZXNzX3plcm8oJmhtbS0+a3JlZikpCiAJCXJldHVybjsKIAotCW11dGV4X2xvY2soJmhtbS0+
bG9jayk7Ci0JaG1tLT5ub3RpZmllcnMtLTsKLQlpZiAoIWhtbS0+bm90aWZpZXJzKSB7Ci0JCXN0
cnVjdCBobW1fcmFuZ2UgKnJhbmdlOwotCi0JCWxpc3RfZm9yX2VhY2hfZW50cnkocmFuZ2UsICZo
bW0tPnJhbmdlcywgbGlzdCkgewotCQkJaWYgKHJhbmdlLT52YWxpZCkKLQkJCQljb250aW51ZTsK
LQkJCXJhbmdlLT52YWxpZCA9IHRydWU7Ci0JCX0KLQkJd2FrZV91cF9hbGwoJmhtbS0+d3EpOwot
CX0KLQltdXRleF91bmxvY2soJmhtbS0+bG9jayk7Ci0KKwlub3RpZmllcnNfZGVjcmVtZW50KGht
bSk7CiAJaG1tX3B1dChobW0pOwogfQogCkBAIC04NjgsNiArODc3LDcgQEAgaW50IGhtbV9yYW5n
ZV9yZWdpc3RlcihzdHJ1Y3QgaG1tX3JhbmdlICpyYW5nZSwKIHsKIAl1bnNpZ25lZCBsb25nIG1h
c2sgPSAoKDFVTCA8PCBwYWdlX3NoaWZ0KSAtIDFVTCk7CiAJc3RydWN0IGhtbSAqaG1tID0gbWly
cm9yLT5obW07CisJdW5zaWduZWQgbG9uZyBmbGFnczsKIAogCXJhbmdlLT52YWxpZCA9IGZhbHNl
OwogCXJhbmdlLT5obW0gPSBOVUxMOwpAQCAtODg2LDcgKzg5Niw3IEBAIGludCBobW1fcmFuZ2Vf
cmVnaXN0ZXIoc3RydWN0IGhtbV9yYW5nZSAqcmFuZ2UsCiAJCXJldHVybiAtRUZBVUxUOwogCiAJ
LyogSW5pdGlhbGl6ZSByYW5nZSB0byB0cmFjayBDUFUgcGFnZSB0YWJsZSB1cGRhdGVzLiAqLwot
CW11dGV4X2xvY2soJmhtbS0+bG9jayk7CisJc3Bpbl9sb2NrX2lycXNhdmUoJmhtbS0+cmFuZ2Vz
X2xvY2ssIGZsYWdzKTsKIAogCXJhbmdlLT5obW0gPSBobW07CiAJa3JlZl9nZXQoJmhtbS0+a3Jl
Zik7CkBAIC04OTgsNyArOTA4LDcgQEAgaW50IGhtbV9yYW5nZV9yZWdpc3RlcihzdHJ1Y3QgaG1t
X3JhbmdlICpyYW5nZSwKIAkgKi8KIAlpZiAoIWhtbS0+bm90aWZpZXJzKQogCQlyYW5nZS0+dmFs
aWQgPSB0cnVlOwotCW11dGV4X3VubG9jaygmaG1tLT5sb2NrKTsKKwlzcGluX3VubG9ja19pcnFy
ZXN0b3JlKCZobW0tPnJhbmdlc19sb2NrLCBmbGFncyk7CiAKIAlyZXR1cm4gMDsKIH0KQEAgLTkx
NCwxMCArOTI0LDExIEBAIEVYUE9SVF9TWU1CT0woaG1tX3JhbmdlX3JlZ2lzdGVyKTsKIHZvaWQg
aG1tX3JhbmdlX3VucmVnaXN0ZXIoc3RydWN0IGhtbV9yYW5nZSAqcmFuZ2UpCiB7CiAJc3RydWN0
IGhtbSAqaG1tID0gcmFuZ2UtPmhtbTsKKwl1bnNpZ25lZCBsb25nIGZsYWdzOwogCi0JbXV0ZXhf
bG9jaygmaG1tLT5sb2NrKTsKKwlzcGluX2xvY2tfaXJxc2F2ZSgmaG1tLT5yYW5nZXNfbG9jaywg
ZmxhZ3MpOwogCWxpc3RfZGVsX2luaXQoJnJhbmdlLT5saXN0KTsKLQltdXRleF91bmxvY2soJmht
bS0+bG9jayk7CisJc3Bpbl91bmxvY2tfaXJxcmVzdG9yZSgmaG1tLT5yYW5nZXNfbG9jaywgZmxh
Z3MpOwogCiAJLyogRHJvcCByZWZlcmVuY2UgdGFrZW4gYnkgaG1tX3JhbmdlX3JlZ2lzdGVyKCkg
Ki8KIAltbXB1dChobW0tPm1tKTsKLS0gCjIuMjAuMQoKX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX18KTm91dmVhdSBtYWlsaW5nIGxpc3QKTm91dmVhdUBsaXN0
cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9s
aXN0aW5mby9ub3V2ZWF1
