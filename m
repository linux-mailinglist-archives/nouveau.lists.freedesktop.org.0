Return-Path: <nouveau-bounces@lists.freedesktop.org>
X-Original-To: lists+nouveau@lfdr.de
Delivered-To: lists+nouveau@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id B61D68CD5B
	for <lists+nouveau@lfdr.de>; Wed, 14 Aug 2019 09:59:49 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 460F089A60;
	Wed, 14 Aug 2019 07:59:48 +0000 (UTC)
X-Original-To: nouveau@lists.freedesktop.org
Delivered-To: nouveau@lists.freedesktop.org
Received: from bombadil.infradead.org (bombadil.infradead.org
 [IPv6:2607:7c80:54:e::133])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 3ED3989A60;
 Wed, 14 Aug 2019 07:59:47 +0000 (UTC)
Received: from [2001:4bb8:180:1ec3:c70:4a89:bc61:2] (helo=localhost)
 by bombadil.infradead.org with esmtpsa (Exim 4.92 #3 (Red Hat Linux))
 id 1hxoC5-0007zb-Cc; Wed, 14 Aug 2019 07:59:41 +0000
From: Christoph Hellwig <hch@lst.de>
To: =?UTF-8?q?J=C3=A9r=C3=B4me=20Glisse?= <jglisse@redhat.com>,
 Jason Gunthorpe <jgg@mellanox.com>, Ben Skeggs <bskeggs@redhat.com>
Date: Wed, 14 Aug 2019 09:59:21 +0200
Message-Id: <20190814075928.23766-4-hch@lst.de>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20190814075928.23766-1-hch@lst.de>
References: <20190814075928.23766-1-hch@lst.de>
MIME-Version: 1.0
X-SRS-Rewrite: SMTP reverse-path rewritten from <hch@infradead.org> by
 bombadil.infradead.org. See http://www.infradead.org/rpr.html
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; q=dns/txt;
 c=relaxed/relaxed; 
 d=infradead.org; s=bombadil.20170209; h=Content-Transfer-Encoding:
 MIME-Version:References:In-Reply-To:Message-Id:Date:Subject:Cc:To:From:Sender
 :Reply-To:Content-Type:Content-ID:Content-Description:Resent-Date:Resent-From
 :Resent-Sender:Resent-To:Resent-Cc:Resent-Message-ID:List-Id:List-Help:
 List-Unsubscribe:List-Subscribe:List-Post:List-Owner:List-Archive;
 bh=hfS6RsR5kjsKcGJBFHaOUQyC3/8MsUUHBDSv8Fc2tAY=; b=aHIuwPxrfJ6VgYAFHUe3HF6WvO
 VvC9ZXTXF3YbQgV/nw+aupbSt5/kftWSDJM6y9+Gy9q5iVowI+1f+Eh/0BUa6tRo/mbtIIfhAEw8a
 VG4obijb46aDWR2joJqDlbTtr0HQq+PQmF4b+d1dN52OBLVSGbu9XUDGYucPSNwxnnPsaFuTnYPTo
 EMwQ2U0+5E0XGwApoLUggf8SbKELOmiOF4yRHfgZrpRzKarTgj3W9F5xjqRk4XNOqFe8odjp3SGqY
 eM3+mob4z2HiWLHg+DUzyoZ9FCC5tSvGXwjMpYxgR8s1MokjeKZPzPda7qldT45SDaykrMgF1+6sM
 ytpTgR6g==;
Subject: [Nouveau] [PATCH 03/10] nouveau: factor out device memory address
 calculation
X-BeenThere: nouveau@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Nouveau development list <nouveau.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/nouveau>,
 <mailto:nouveau-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/nouveau>
List-Post: <mailto:nouveau@lists.freedesktop.org>
List-Help: <mailto:nouveau-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/nouveau>,
 <mailto:nouveau-request@lists.freedesktop.org?subject=subscribe>
Cc: Ralph Campbell <rcampbell@nvidia.com>, nouveau@lists.freedesktop.org,
 linux-kernel@vger.kernel.org, dri-devel@lists.freedesktop.org,
 Bharata B Rao <bharata@linux.ibm.com>, linux-mm@kvack.org,
 Andrew Morton <akpm@linux-foundation.org>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: nouveau-bounces@lists.freedesktop.org
Sender: "Nouveau" <nouveau-bounces@lists.freedesktop.org>

RmFjdG9yIG91dCB0aGUgcmVwZWF0ZWQgZGV2aWNlIG1lbW9yeSBhZGRyZXNzIGNhbGN1bGF0aW9u
IGludG8KYSBoZWxwZXIuCgpTaWduZWQtb2ZmLWJ5OiBDaHJpc3RvcGggSGVsbHdpZyA8aGNoQGxz
dC5kZT4KUmV2aWV3ZWQtYnk6IFJhbHBoIENhbXBiZWxsIDxyY2FtcGJlbGxAbnZpZGlhLmNvbT4K
LS0tCiBkcml2ZXJzL2dwdS9kcm0vbm91dmVhdS9ub3V2ZWF1X2RtZW0uYyB8IDQyICsrKysrKysr
KysrLS0tLS0tLS0tLS0tLS0tCiAxIGZpbGUgY2hhbmdlZCwgMTcgaW5zZXJ0aW9ucygrKSwgMjUg
ZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL25vdXZlYXUvbm91dmVh
dV9kbWVtLmMgYi9kcml2ZXJzL2dwdS9kcm0vbm91dmVhdS9ub3V2ZWF1X2RtZW0uYwppbmRleCBl
Njk2MTU3Zjc3MWUuLmQ0NjliYzMzNDQzOCAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL25v
dXZlYXUvbm91dmVhdV9kbWVtLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL25vdXZlYXUvbm91dmVh
dV9kbWVtLmMKQEAgLTEwMiw2ICsxMDIsMTQgQEAgc3RydWN0IG5vdXZlYXVfbWlncmF0ZSB7CiAJ
dW5zaWduZWQgbG9uZyBkbWFfbnI7CiB9OwogCitzdGF0aWMgdW5zaWduZWQgbG9uZyBub3V2ZWF1
X2RtZW1fcGFnZV9hZGRyKHN0cnVjdCBwYWdlICpwYWdlKQoreworCXN0cnVjdCBub3V2ZWF1X2Rt
ZW1fY2h1bmsgKmNodW5rID0gcGFnZS0+em9uZV9kZXZpY2VfZGF0YTsKKwl1bnNpZ25lZCBsb25n
IGlkeCA9IHBhZ2VfdG9fcGZuKHBhZ2UpIC0gY2h1bmstPnBmbl9maXJzdDsKKworCXJldHVybiAo
aWR4IDw8IFBBR0VfU0hJRlQpICsgY2h1bmstPmJvLT5iby5vZmZzZXQ7Cit9CisKIHN0YXRpYyB2
b2lkIG5vdXZlYXVfZG1lbV9wYWdlX2ZyZWUoc3RydWN0IHBhZ2UgKnBhZ2UpCiB7CiAJc3RydWN0
IG5vdXZlYXVfZG1lbV9jaHVuayAqY2h1bmsgPSBwYWdlLT56b25lX2RldmljZV9kYXRhOwpAQCAt
MTY5LDkgKzE3Nyw3IEBAIG5vdXZlYXVfZG1lbV9mYXVsdF9hbGxvY19hbmRfY29weShzdHJ1Y3Qg
dm1fYXJlYV9zdHJ1Y3QgKnZtYSwKIAkvKiBDb3B5IHRoaW5ncyBvdmVyICovCiAJY29weSA9IGRy
bS0+ZG1lbS0+bWlncmF0ZS5jb3B5X2Z1bmM7CiAJZm9yIChhZGRyID0gc3RhcnQsIGkgPSAwOyBh
ZGRyIDwgZW5kOyBhZGRyICs9IFBBR0VfU0laRSwgaSsrKSB7Ci0JCXN0cnVjdCBub3V2ZWF1X2Rt
ZW1fY2h1bmsgKmNodW5rOwogCQlzdHJ1Y3QgcGFnZSAqc3BhZ2UsICpkcGFnZTsKLQkJdTY0IHNy
Y19hZGRyLCBkc3RfYWRkcjsKIAogCQlkcGFnZSA9IG1pZ3JhdGVfcGZuX3RvX3BhZ2UoZHN0X3Bm
bnNbaV0pOwogCQlpZiAoIWRwYWdlIHx8IGRzdF9wZm5zW2ldID09IE1JR1JBVEVfUEZOX0VSUk9S
KQpAQCAtMTk0LDE0ICsyMDAsMTAgQEAgbm91dmVhdV9kbWVtX2ZhdWx0X2FsbG9jX2FuZF9jb3B5
KHN0cnVjdCB2bV9hcmVhX3N0cnVjdCAqdm1hLAogCQkJY29udGludWU7CiAJCX0KIAotCQlkc3Rf
YWRkciA9IGZhdWx0LT5kbWFbZmF1bHQtPm5wYWdlcysrXTsKLQotCQljaHVuayA9IHNwYWdlLT56
b25lX2RldmljZV9kYXRhOwotCQlzcmNfYWRkciA9IHBhZ2VfdG9fcGZuKHNwYWdlKSAtIGNodW5r
LT5wZm5fZmlyc3Q7Ci0JCXNyY19hZGRyID0gKHNyY19hZGRyIDw8IFBBR0VfU0hJRlQpICsgY2h1
bmstPmJvLT5iby5vZmZzZXQ7Ci0KLQkJcmV0ID0gY29weShkcm0sIDEsIE5PVVZFQVVfQVBFUl9I
T1NULCBkc3RfYWRkciwKLQkJCQkgICBOT1VWRUFVX0FQRVJfVlJBTSwgc3JjX2FkZHIpOworCQly
ZXQgPSBjb3B5KGRybSwgMSwgTk9VVkVBVV9BUEVSX0hPU1QsCisJCQkJZmF1bHQtPmRtYVtmYXVs
dC0+bnBhZ2VzKytdLAorCQkJCU5PVVZFQVVfQVBFUl9WUkFNLAorCQkJCW5vdXZlYXVfZG1lbV9w
YWdlX2FkZHIoc3BhZ2UpKTsKIAkJaWYgKHJldCkgewogCQkJZHN0X3BmbnNbaV0gPSBNSUdSQVRF
X1BGTl9FUlJPUjsKIAkJCV9fZnJlZV9wYWdlKGRwYWdlKTsKQEAgLTY4NywxOCArNjg5LDEyIEBA
IG5vdXZlYXVfZG1lbV9taWdyYXRlX2FsbG9jX2FuZF9jb3B5KHN0cnVjdCB2bV9hcmVhX3N0cnVj
dCAqdm1hLAogCS8qIENvcHkgdGhpbmdzIG92ZXIgKi8KIAljb3B5ID0gZHJtLT5kbWVtLT5taWdy
YXRlLmNvcHlfZnVuYzsKIAlmb3IgKGFkZHIgPSBzdGFydCwgaSA9IDA7IGFkZHIgPCBlbmQ7IGFk
ZHIgKz0gUEFHRV9TSVpFLCBpKyspIHsKLQkJc3RydWN0IG5vdXZlYXVfZG1lbV9jaHVuayAqY2h1
bms7CiAJCXN0cnVjdCBwYWdlICpzcGFnZSwgKmRwYWdlOwotCQl1NjQgc3JjX2FkZHIsIGRzdF9h
ZGRyOwogCiAJCWRwYWdlID0gbWlncmF0ZV9wZm5fdG9fcGFnZShkc3RfcGZuc1tpXSk7CiAJCWlm
ICghZHBhZ2UgfHwgZHN0X3BmbnNbaV0gPT0gTUlHUkFURV9QRk5fRVJST1IpCiAJCQljb250aW51
ZTsKIAotCQljaHVuayA9IGRwYWdlLT56b25lX2RldmljZV9kYXRhOwotCQlkc3RfYWRkciA9IHBh
Z2VfdG9fcGZuKGRwYWdlKSAtIGNodW5rLT5wZm5fZmlyc3Q7Ci0JCWRzdF9hZGRyID0gKGRzdF9h
ZGRyIDw8IFBBR0VfU0hJRlQpICsgY2h1bmstPmJvLT5iby5vZmZzZXQ7Ci0KIAkJc3BhZ2UgPSBt
aWdyYXRlX3Bmbl90b19wYWdlKHNyY19wZm5zW2ldKTsKIAkJaWYgKCFzcGFnZSB8fCAhKHNyY19w
Zm5zW2ldICYgTUlHUkFURV9QRk5fTUlHUkFURSkpIHsKIAkJCW5vdXZlYXVfZG1lbV9wYWdlX2Zy
ZWVfbG9ja2VkKGRybSwgZHBhZ2UpOwpAQCAtNzE2LDEwICs3MTIsMTAgQEAgbm91dmVhdV9kbWVt
X21pZ3JhdGVfYWxsb2NfYW5kX2NvcHkoc3RydWN0IHZtX2FyZWFfc3RydWN0ICp2bWEsCiAJCQlj
b250aW51ZTsKIAkJfQogCi0JCXNyY19hZGRyID0gbWlncmF0ZS0+ZG1hW21pZ3JhdGUtPmRtYV9u
cisrXTsKLQotCQlyZXQgPSBjb3B5KGRybSwgMSwgTk9VVkVBVV9BUEVSX1ZSQU0sIGRzdF9hZGRy
LAotCQkJCSAgIE5PVVZFQVVfQVBFUl9IT1NULCBzcmNfYWRkcik7CisJCXJldCA9IGNvcHkoZHJt
LCAxLCBOT1VWRUFVX0FQRVJfVlJBTSwKKwkJCQlub3V2ZWF1X2RtZW1fcGFnZV9hZGRyKGRwYWdl
KSwKKwkJCQlOT1VWRUFVX0FQRVJfSE9TVCwKKwkJCQltaWdyYXRlLT5kbWFbbWlncmF0ZS0+ZG1h
X25yKytdKTsKIAkJaWYgKHJldCkgewogCQkJbm91dmVhdV9kbWVtX3BhZ2VfZnJlZV9sb2NrZWQo
ZHJtLCBkcGFnZSk7CiAJCQlkc3RfcGZuc1tpXSA9IDA7CkBAIC04NDYsNyArODQyLDYgQEAgbm91
dmVhdV9kbWVtX2NvbnZlcnRfcGZuKHN0cnVjdCBub3V2ZWF1X2RybSAqZHJtLAogCiAJbnBhZ2Vz
ID0gKHJhbmdlLT5lbmQgLSByYW5nZS0+c3RhcnQpID4+IFBBR0VfU0hJRlQ7CiAJZm9yIChpID0g
MDsgaSA8IG5wYWdlczsgKytpKSB7Ci0JCXN0cnVjdCBub3V2ZWF1X2RtZW1fY2h1bmsgKmNodW5r
OwogCQlzdHJ1Y3QgcGFnZSAqcGFnZTsKIAkJdWludDY0X3QgYWRkcjsKIApAQCAtODY0LDEwICs4
NTksNyBAQCBub3V2ZWF1X2RtZW1fY29udmVydF9wZm4oc3RydWN0IG5vdXZlYXVfZHJtICpkcm0s
CiAJCQljb250aW51ZTsKIAkJfQogCi0JCWNodW5rID0gcGFnZS0+em9uZV9kZXZpY2VfZGF0YTsK
LQkJYWRkciA9IHBhZ2VfdG9fcGZuKHBhZ2UpIC0gY2h1bmstPnBmbl9maXJzdDsKLQkJYWRkciA9
IChhZGRyICsgY2h1bmstPmJvLT5iby5tZW0uc3RhcnQpIDw8IFBBR0VfU0hJRlQ7Ci0KKwkJYWRk
ciA9IG5vdXZlYXVfZG1lbV9wYWdlX2FkZHIocGFnZSk7CiAJCXJhbmdlLT5wZm5zW2ldICY9ICgo
MVVMIDw8IHJhbmdlLT5wZm5fc2hpZnQpIC0gMSk7CiAJCXJhbmdlLT5wZm5zW2ldIHw9IChhZGRy
ID4+IFBBR0VfU0hJRlQpIDw8IHJhbmdlLT5wZm5fc2hpZnQ7CiAJfQotLSAKMi4yMC4xCgpfX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpOb3V2ZWF1IG1haWxp
bmcgbGlzdApOb3V2ZWF1QGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVk
ZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL25vdXZlYXU=
