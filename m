Return-Path: <nouveau-bounces@lists.freedesktop.org>
X-Original-To: lists+nouveau@lfdr.de
Delivered-To: lists+nouveau@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id F1AC35B4AF
	for <lists+nouveau@lfdr.de>; Mon,  1 Jul 2019 08:20:48 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 7C4B489E8C;
	Mon,  1 Jul 2019 06:20:47 +0000 (UTC)
X-Original-To: nouveau@lists.freedesktop.org
Delivered-To: nouveau@lists.freedesktop.org
Received: from bombadil.infradead.org (bombadil.infradead.org
 [IPv6:2607:7c80:54:e::133])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 1E11B89F08;
 Mon,  1 Jul 2019 06:20:46 +0000 (UTC)
Received: from [46.140.178.35] (helo=localhost)
 by bombadil.infradead.org with esmtpsa (Exim 4.92 #3 (Red Hat Linux))
 id 1hhpgA-0002y7-L6; Mon, 01 Jul 2019 06:20:43 +0000
From: Christoph Hellwig <hch@lst.de>
To: Dan Williams <dan.j.williams@intel.com>,
 =?UTF-8?q?J=C3=A9r=C3=B4me=20Glisse?= <jglisse@redhat.com>,
 Jason Gunthorpe <jgg@mellanox.com>, Ben Skeggs <bskeggs@redhat.com>
Date: Mon,  1 Jul 2019 08:20:07 +0200
Message-Id: <20190701062020.19239-10-hch@lst.de>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20190701062020.19239-1-hch@lst.de>
References: <20190701062020.19239-1-hch@lst.de>
MIME-Version: 1.0
X-SRS-Rewrite: SMTP reverse-path rewritten from <hch@infradead.org> by
 bombadil.infradead.org. See http://www.infradead.org/rpr.html
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; q=dns/txt;
 c=relaxed/relaxed; 
 d=infradead.org; s=bombadil.20170209; h=Content-Transfer-Encoding:
 MIME-Version:References:In-Reply-To:Message-Id:Date:Subject:Cc:To:From:Sender
 :Reply-To:Content-Type:Content-ID:Content-Description:Resent-Date:Resent-From
 :Resent-Sender:Resent-To:Resent-Cc:Resent-Message-ID:List-Id:List-Help:
 List-Unsubscribe:List-Subscribe:List-Post:List-Owner:List-Archive;
 bh=APKBQWkk9iHwyQHEt2C0MEBOgtO6KbM8T5bZXthkZZI=; b=gSbk2W6E84lf5FtDNmA7UbJzV8
 /YpjENtceLBi7lcdSkKI3hddigiEEfPq448QumXbzCmOvF+HQ4eGiOVwzgEgTxo59mprNYGLlbRal
 pFad60P91vtTjcQCJM33sMokpMT0eR115j8oJP1AFdexcCZJzIE+KPqTW59nqSqC58f1njztm+KLt
 nDzWjqQ54DQdSWM+FGXGX7f9sA7DlL6G91SyOHzqRMJtGs2Vw3Ec9RA8nXlpy5RPimyAnOMxTBWv8
 scgz4P+mEmSq7QkjP1YKS3IDhkGZzrRmUCpak5IqWHEFnT7ZLMR6eXSwhpA9HpzzWOMtkhjLVW6wl
 FwufaIVQ==;
Subject: [Nouveau] [PATCH 09/22] mm/hmm: Simplify hmm_get_or_create and make
 it reliable
X-BeenThere: nouveau@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Nouveau development list <nouveau.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/nouveau>,
 <mailto:nouveau-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/nouveau>
List-Post: <mailto:nouveau@lists.freedesktop.org>
List-Help: <mailto:nouveau-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/nouveau>,
 <mailto:nouveau-request@lists.freedesktop.org?subject=subscribe>
Cc: Philip Yang <Philip.Yang@amd.com>, Ralph Campbell <rcampbell@nvidia.com>,
 linux-nvdimm@lists.01.org, linux-pci@vger.kernel.org,
 linux-kernel@vger.kernel.org, dri-devel@lists.freedesktop.org,
 linux-mm@kvack.org, nouveau@lists.freedesktop.org,
 Ira Weiny <ira.weiny@intel.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: nouveau-bounces@lists.freedesktop.org
Sender: "Nouveau" <nouveau-bounces@lists.freedesktop.org>

RnJvbTogSmFzb24gR3VudGhvcnBlIDxqZ2dAbWVsbGFub3guY29tPgoKQXMgY29kZWQgdGhpcyBm
dW5jdGlvbiBjYW4gZmFsc2UtZmFpbCBpbiB2YXJpb3VzIHJhY3kgc2l0dWF0aW9ucy4gTWFrZSBp
dApyZWxpYWJsZSBhbmQgc2ltcGxlciBieSBydW5uaW5nIHVuZGVyIHRoZSB3cml0ZSBzaWRlIG9m
IHRoZSBtbWFwX3NlbSBhbmQKYXZvaWRpbmcgdGhlIGZhbHNlLWZhaWxpbmcgY29tcGFyZS9leGNo
YW5nZSBwYXR0ZXJuLiBEdWUgdG8gdGhlIG1tYXBfc2VtCnRoaXMgbm8gbG9uZ2VyIGhhcyB0byBh
dm9pZCByYWNpbmcgd2l0aCBhIDJuZCBwYXJhbGxlbApobW1fZ2V0X29yX2NyZWF0ZSgpLgoKVW5m
b3J0dW5hdGVseSB0aGlzIHN0aWxsIGhhcyB0byB1c2UgdGhlIHBhZ2VfdGFibGVfbG9jayBhcyB0
aGUKbm9uLXNsZWVwaW5nIGxvY2sgcHJvdGVjdGluZyBtbS0+aG1tLCBzaW5jZSB0aGUgY29udGV4
dHMgd2hlcmUgd2UgZnJlZSB0aGUKaG1tIGFyZSBpbmNvbXBhdGlibGUgd2l0aCBtbWFwX3NlbS4K
ClNpZ25lZC1vZmYtYnk6IEphc29uIEd1bnRob3JwZSA8amdnQG1lbGxhbm94LmNvbT4KUmV2aWV3
ZWQtYnk6IEpvaG4gSHViYmFyZCA8amh1YmJhcmRAbnZpZGlhLmNvbT4KUmV2aWV3ZWQtYnk6IFJh
bHBoIENhbXBiZWxsIDxyY2FtcGJlbGxAbnZpZGlhLmNvbT4KUmV2aWV3ZWQtYnk6IElyYSBXZWlu
eSA8aXJhLndlaW55QGludGVsLmNvbT4KUmV2aWV3ZWQtYnk6IENocmlzdG9waCBIZWxsd2lnIDxo
Y2hAbHN0LmRlPgpUZXN0ZWQtYnk6IFBoaWxpcCBZYW5nIDxQaGlsaXAuWWFuZ0BhbWQuY29tPgot
LS0KIG1tL2htbS5jIHwgNzcgKysrKysrKysrKysrKysrKysrKysrKy0tLS0tLS0tLS0tLS0tLS0t
LS0tLS0tLS0tLS0tLS0tLS0KIDEgZmlsZSBjaGFuZ2VkLCAzMCBpbnNlcnRpb25zKCspLCA0NyBk
ZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9tbS9obW0uYyBiL21tL2htbS5jCmluZGV4IDA4MGIx
N2EyZTg3ZS4uMDQyM2Y0Y2EzYTdlIDEwMDY0NAotLS0gYS9tbS9obW0uYworKysgYi9tbS9obW0u
YwpAQCAtMzEsMTYgKzMxLDYgQEAKICNpZiBJU19FTkFCTEVEKENPTkZJR19ITU1fTUlSUk9SKQog
c3RhdGljIGNvbnN0IHN0cnVjdCBtbXVfbm90aWZpZXJfb3BzIGhtbV9tbXVfbm90aWZpZXJfb3Bz
OwogCi1zdGF0aWMgaW5saW5lIHN0cnVjdCBobW0gKm1tX2dldF9obW0oc3RydWN0IG1tX3N0cnVj
dCAqbW0pCi17Ci0Jc3RydWN0IGhtbSAqaG1tID0gUkVBRF9PTkNFKG1tLT5obW0pOwotCi0JaWYg
KGhtbSAmJiBrcmVmX2dldF91bmxlc3NfemVybygmaG1tLT5rcmVmKSkKLQkJcmV0dXJuIGhtbTsK
LQotCXJldHVybiBOVUxMOwotfQotCiAvKioKICAqIGhtbV9nZXRfb3JfY3JlYXRlIC0gcmVnaXN0
ZXIgSE1NIGFnYWluc3QgYW4gbW0gKEhNTSBpbnRlcm5hbCkKICAqCkBAIC01NSwxMSArNDUsMTYg
QEAgc3RhdGljIGlubGluZSBzdHJ1Y3QgaG1tICptbV9nZXRfaG1tKHN0cnVjdCBtbV9zdHJ1Y3Qg
Km1tKQogICovCiBzdGF0aWMgc3RydWN0IGhtbSAqaG1tX2dldF9vcl9jcmVhdGUoc3RydWN0IG1t
X3N0cnVjdCAqbW0pCiB7Ci0Jc3RydWN0IGhtbSAqaG1tID0gbW1fZ2V0X2htbShtbSk7Ci0JYm9v
bCBjbGVhbnVwID0gZmFsc2U7CisJc3RydWN0IGhtbSAqaG1tOworCisJbG9ja2RlcF9hc3NlcnRf
aGVsZF9leGNsdXNpdmUoJm1tLT5tbWFwX3NlbSk7CiAKLQlpZiAoaG1tKQotCQlyZXR1cm4gaG1t
OworCS8qIEFidXNlIHRoZSBwYWdlX3RhYmxlX2xvY2sgdG8gYWxzbyBwcm90ZWN0IG1tLT5obW0u
ICovCisJc3Bpbl9sb2NrKCZtbS0+cGFnZV90YWJsZV9sb2NrKTsKKwlobW0gPSBtbS0+aG1tOwor
CWlmIChtbS0+aG1tICYmIGtyZWZfZ2V0X3VubGVzc196ZXJvKCZtbS0+aG1tLT5rcmVmKSkKKwkJ
Z290byBvdXRfdW5sb2NrOworCXNwaW5fdW5sb2NrKCZtbS0+cGFnZV90YWJsZV9sb2NrKTsKIAog
CWhtbSA9IGttYWxsb2Moc2l6ZW9mKCpobW0pLCBHRlBfS0VSTkVMKTsKIAlpZiAoIWhtbSkKQEAg
LTc0LDU3ICs2OSw0NSBAQCBzdGF0aWMgc3RydWN0IGhtbSAqaG1tX2dldF9vcl9jcmVhdGUoc3Ry
dWN0IG1tX3N0cnVjdCAqbW0pCiAJaG1tLT5ub3RpZmllcnMgPSAwOwogCWhtbS0+ZGVhZCA9IGZh
bHNlOwogCWhtbS0+bW0gPSBtbTsKLQltbWdyYWIoaG1tLT5tbSk7CiAKLQlzcGluX2xvY2soJm1t
LT5wYWdlX3RhYmxlX2xvY2spOwotCWlmICghbW0tPmhtbSkKLQkJbW0tPmhtbSA9IGhtbTsKLQll
bHNlCi0JCWNsZWFudXAgPSB0cnVlOwotCXNwaW5fdW5sb2NrKCZtbS0+cGFnZV90YWJsZV9sb2Nr
KTsKKwlobW0tPm1tdV9ub3RpZmllci5vcHMgPSAmaG1tX21tdV9ub3RpZmllcl9vcHM7CisJaWYg
KF9fbW11X25vdGlmaWVyX3JlZ2lzdGVyKCZobW0tPm1tdV9ub3RpZmllciwgbW0pKSB7CisJCWtm
cmVlKGhtbSk7CisJCXJldHVybiBOVUxMOworCX0KIAotCWlmIChjbGVhbnVwKQotCQlnb3RvIGVy
cm9yOworCW1tZ3JhYihobW0tPm1tKTsKIAogCS8qCi0JICogV2Ugc2hvdWxkIG9ubHkgZ2V0IGhl
cmUgaWYgaG9sZCB0aGUgbW1hcF9zZW0gaW4gd3JpdGUgbW9kZSBpZSBvbgotCSAqIHJlZ2lzdHJh
dGlvbiBvZiBmaXJzdCBtaXJyb3IgdGhyb3VnaCBobW1fbWlycm9yX3JlZ2lzdGVyKCkKKwkgKiBX
ZSBob2xkIHRoZSBleGNsdXNpdmUgbW1hcF9zZW0gaGVyZSBzbyB3ZSBrbm93IHRoYXQgbW0tPmht
bSBpcworCSAqIHN0aWxsIE5VTEwgb3IgMCBrcmVmLCBhbmQgaXMgc2FmZSB0byB1cGRhdGUuCiAJ
ICovCi0JaG1tLT5tbXVfbm90aWZpZXIub3BzID0gJmhtbV9tbXVfbm90aWZpZXJfb3BzOwotCWlm
IChfX21tdV9ub3RpZmllcl9yZWdpc3RlcigmaG1tLT5tbXVfbm90aWZpZXIsIG1tKSkKLQkJZ290
byBlcnJvcl9tbTsKLQotCXJldHVybiBobW07Ci0KLWVycm9yX21tOgogCXNwaW5fbG9jaygmbW0t
PnBhZ2VfdGFibGVfbG9jayk7Ci0JaWYgKG1tLT5obW0gPT0gaG1tKQotCQltbS0+aG1tID0gTlVM
TDsKKwltbS0+aG1tID0gaG1tOworCitvdXRfdW5sb2NrOgogCXNwaW5fdW5sb2NrKCZtbS0+cGFn
ZV90YWJsZV9sb2NrKTsKLWVycm9yOgotCW1tZHJvcChobW0tPm1tKTsKLQlrZnJlZShobW0pOwot
CXJldHVybiBOVUxMOworCXJldHVybiBobW07CiB9CiAKIHN0YXRpYyB2b2lkIGhtbV9mcmVlX3Jj
dShzdHJ1Y3QgcmN1X2hlYWQgKnJjdSkKIHsKLQlrZnJlZShjb250YWluZXJfb2YocmN1LCBzdHJ1
Y3QgaG1tLCByY3UpKTsKKwlzdHJ1Y3QgaG1tICpobW0gPSBjb250YWluZXJfb2YocmN1LCBzdHJ1
Y3QgaG1tLCByY3UpOworCisJbW1kcm9wKGhtbS0+bW0pOworCWtmcmVlKGhtbSk7CiB9CiAKIHN0
YXRpYyB2b2lkIGhtbV9mcmVlKHN0cnVjdCBrcmVmICprcmVmKQogewogCXN0cnVjdCBobW0gKmht
bSA9IGNvbnRhaW5lcl9vZihrcmVmLCBzdHJ1Y3QgaG1tLCBrcmVmKTsKLQlzdHJ1Y3QgbW1fc3Ry
dWN0ICptbSA9IGhtbS0+bW07CiAKLQltbXVfbm90aWZpZXJfdW5yZWdpc3Rlcl9ub19yZWxlYXNl
KCZobW0tPm1tdV9ub3RpZmllciwgbW0pOworCXNwaW5fbG9jaygmaG1tLT5tbS0+cGFnZV90YWJs
ZV9sb2NrKTsKKwlpZiAoaG1tLT5tbS0+aG1tID09IGhtbSkKKwkJaG1tLT5tbS0+aG1tID0gTlVM
TDsKKwlzcGluX3VubG9jaygmaG1tLT5tbS0+cGFnZV90YWJsZV9sb2NrKTsKIAotCXNwaW5fbG9j
aygmbW0tPnBhZ2VfdGFibGVfbG9jayk7Ci0JaWYgKG1tLT5obW0gPT0gaG1tKQotCQltbS0+aG1t
ID0gTlVMTDsKLQlzcGluX3VubG9jaygmbW0tPnBhZ2VfdGFibGVfbG9jayk7Ci0KLQltbWRyb3Ao
aG1tLT5tbSk7CisJbW11X25vdGlmaWVyX3VucmVnaXN0ZXJfbm9fcmVsZWFzZSgmaG1tLT5tbXVf
bm90aWZpZXIsIGhtbS0+bW0pOwogCW1tdV9ub3RpZmllcl9jYWxsX3NyY3UoJmhtbS0+cmN1LCBo
bW1fZnJlZV9yY3UpOwogfQogCi0tIAoyLjIwLjEKCl9fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fCk5vdXZlYXUgbWFpbGluZyBsaXN0Ck5vdXZlYXVAbGlzdHMu
ZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlz
dGluZm8vbm91dmVhdQ==
