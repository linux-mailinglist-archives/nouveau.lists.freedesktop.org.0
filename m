Return-Path: <nouveau-bounces@lists.freedesktop.org>
X-Original-To: lists+nouveau@lfdr.de
Delivered-To: lists+nouveau@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 1EC3A48228
	for <lists+nouveau@lfdr.de>; Mon, 17 Jun 2019 14:28:20 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 87C6F89230;
	Mon, 17 Jun 2019 12:28:18 +0000 (UTC)
X-Original-To: nouveau@lists.freedesktop.org
Delivered-To: nouveau@lists.freedesktop.org
Received: from bombadil.infradead.org (bombadil.infradead.org
 [IPv6:2607:7c80:54:e::133])
 by gabe.freedesktop.org (Postfix) with ESMTPS id E16BF8922E;
 Mon, 17 Jun 2019 12:28:16 +0000 (UTC)
Received: from clnet-p19-102.ikbnet.co.at ([83.175.77.102] helo=localhost)
 by bombadil.infradead.org with esmtpsa (Exim 4.92 #3 (Red Hat Linux))
 id 1hcqk8-0000Gn-Ll; Mon, 17 Jun 2019 12:28:12 +0000
From: Christoph Hellwig <hch@lst.de>
To: Dan Williams <dan.j.williams@intel.com>,
 =?UTF-8?q?J=C3=A9r=C3=B4me=20Glisse?= <jglisse@redhat.com>,
 Jason Gunthorpe <jgg@mellanox.com>, Ben Skeggs <bskeggs@redhat.com>
Date: Mon, 17 Jun 2019 14:27:24 +0200
Message-Id: <20190617122733.22432-17-hch@lst.de>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20190617122733.22432-1-hch@lst.de>
References: <20190617122733.22432-1-hch@lst.de>
MIME-Version: 1.0
X-SRS-Rewrite: SMTP reverse-path rewritten from <hch@infradead.org> by
 bombadil.infradead.org. See http://www.infradead.org/rpr.html
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; q=dns/txt;
 c=relaxed/relaxed; 
 d=infradead.org; s=bombadil.20170209; h=Content-Transfer-Encoding:
 MIME-Version:References:In-Reply-To:Message-Id:Date:Subject:Cc:To:From:Sender
 :Reply-To:Content-Type:Content-ID:Content-Description:Resent-Date:Resent-From
 :Resent-Sender:Resent-To:Resent-Cc:Resent-Message-ID:List-Id:List-Help:
 List-Unsubscribe:List-Subscribe:List-Post:List-Owner:List-Archive;
 bh=bqNW86dzEIGFtFX91S0QfixvDgbjQWnIT6qUU0eVEH4=; b=WuL0DYWbzTX1df3odeTY431W11
 U+IcQwoSHpIn1fMOzejiKLQ4T8swbios1PHMUkKcA2qDdFfDiObZfLsILw7OcEJxSkmTjZINPR6Ex
 JU5UL9obm/Ujq0gzLG5GLwV6DXCHwO9XcVhmV5JdSTTENkyBGpYwzs9vK4bZgbYpWH0X2uxeezDtb
 zTKdJMavLuTl530T4mh89YjZh7oD2lAFwjczLk5AV3FaKTfWD1grijdKZyC4ZIwEVCxgVy3oz5n7T
 RBeVOLMjWP1rN6VKNGoDkd/NFq1PppJFQffAUKysbEbgpOzqWo2a2uIJuDwVJADkhF56XaEwfYDf2
 sPXWKLLg==;
Subject: [Nouveau] [PATCH 16/25] PCI/P2PDMA: use the dev_pagemap internal
 refcount
X-BeenThere: nouveau@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Nouveau development list <nouveau.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/nouveau>,
 <mailto:nouveau-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/nouveau>
List-Post: <mailto:nouveau@lists.freedesktop.org>
List-Help: <mailto:nouveau-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/nouveau>,
 <mailto:nouveau-request@lists.freedesktop.org?subject=subscribe>
Cc: linux-nvdimm@lists.01.org, linux-pci@vger.kernel.org,
 linux-kernel@vger.kernel.org, dri-devel@lists.freedesktop.org,
 linux-mm@kvack.org, nouveau@lists.freedesktop.org
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: nouveau-bounces@lists.freedesktop.org
Sender: "Nouveau" <nouveau-bounces@lists.freedesktop.org>

VGhlIGZ1bmN0aW9uYWxpdHkgaXMgaWRlbnRpY2FsIHRvIHRoZSBvbmUgY3VycmVudGx5IG9wZW4g
Y29kZWQgaW4KcDJwZG1hLmMuCgpTaWduZWQtb2ZmLWJ5OiBDaHJpc3RvcGggSGVsbHdpZyA8aGNo
QGxzdC5kZT4KLS0tCiBkcml2ZXJzL3BjaS9wMnBkbWEuYyB8IDU2ICsrKystLS0tLS0tLS0tLS0t
LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAxIGZpbGUgY2hhbmdlZCwgNCBpbnNlcnRpb25z
KCspLCA1MiBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9kcml2ZXJzL3BjaS9wMnBkbWEuYyBi
L2RyaXZlcnMvcGNpL3AycGRtYS5jCmluZGV4IDQ4YTg4MTU4ZTQ2YS4uNjA4Zjg0ZGY2MDRhIDEw
MDY0NAotLS0gYS9kcml2ZXJzL3BjaS9wMnBkbWEuYworKysgYi9kcml2ZXJzL3BjaS9wMnBkbWEu
YwpAQCAtMjQsMTIgKzI0LDYgQEAgc3RydWN0IHBjaV9wMnBkbWEgewogCWJvb2wgcDJwbWVtX3B1
Ymxpc2hlZDsKIH07CiAKLXN0cnVjdCBwMnBkbWFfcGFnZW1hcCB7Ci0Jc3RydWN0IGRldl9wYWdl
bWFwIHBnbWFwOwotCXN0cnVjdCBwZXJjcHVfcmVmIHJlZjsKLQlzdHJ1Y3QgY29tcGxldGlvbiBy
ZWZfZG9uZTsKLX07Ci0KIHN0YXRpYyBzc2l6ZV90IHNpemVfc2hvdyhzdHJ1Y3QgZGV2aWNlICpk
ZXYsIHN0cnVjdCBkZXZpY2VfYXR0cmlidXRlICphdHRyLAogCQkJIGNoYXIgKmJ1ZikKIHsKQEAg
LTc4LDMyICs3Miw2IEBAIHN0YXRpYyBjb25zdCBzdHJ1Y3QgYXR0cmlidXRlX2dyb3VwIHAycG1l
bV9ncm91cCA9IHsKIAkubmFtZSA9ICJwMnBtZW0iLAogfTsKIAotc3RhdGljIHN0cnVjdCBwMnBk
bWFfcGFnZW1hcCAqdG9fcDJwX3BnbWFwKHN0cnVjdCBwZXJjcHVfcmVmICpyZWYpCi17Ci0JcmV0
dXJuIGNvbnRhaW5lcl9vZihyZWYsIHN0cnVjdCBwMnBkbWFfcGFnZW1hcCwgcmVmKTsKLX0KLQot
c3RhdGljIHZvaWQgcGNpX3AycGRtYV9wZXJjcHVfcmVsZWFzZShzdHJ1Y3QgcGVyY3B1X3JlZiAq
cmVmKQotewotCXN0cnVjdCBwMnBkbWFfcGFnZW1hcCAqcDJwX3BnbWFwID0gdG9fcDJwX3BnbWFw
KHJlZik7Ci0KLQljb21wbGV0ZSgmcDJwX3BnbWFwLT5yZWZfZG9uZSk7Ci19Ci0KLXN0YXRpYyB2
b2lkIHBjaV9wMnBkbWFfcGVyY3B1X2tpbGwoc3RydWN0IGRldl9wYWdlbWFwICpwZ21hcCkKLXsK
LQlwZXJjcHVfcmVmX2tpbGwocGdtYXAtPnJlZik7Ci19Ci0KLXN0YXRpYyB2b2lkIHBjaV9wMnBk
bWFfcGVyY3B1X2NsZWFudXAoc3RydWN0IGRldl9wYWdlbWFwICpwZ21hcCkKLXsKLQlzdHJ1Y3Qg
cDJwZG1hX3BhZ2VtYXAgKnAycF9wZ21hcCA9Ci0JCWNvbnRhaW5lcl9vZihwZ21hcCwgc3RydWN0
IHAycGRtYV9wYWdlbWFwLCBwZ21hcCk7Ci0KLQl3YWl0X2Zvcl9jb21wbGV0aW9uKCZwMnBfcGdt
YXAtPnJlZl9kb25lKTsKLQlwZXJjcHVfcmVmX2V4aXQoJnAycF9wZ21hcC0+cmVmKTsKLX0KLQog
c3RhdGljIHZvaWQgcGNpX3AycGRtYV9yZWxlYXNlKHZvaWQgKmRhdGEpCiB7CiAJc3RydWN0IHBj
aV9kZXYgKnBkZXYgPSBkYXRhOwpAQCAtMTUzLDExICsxMjEsNiBAQCBzdGF0aWMgaW50IHBjaV9w
MnBkbWFfc2V0dXAoc3RydWN0IHBjaV9kZXYgKnBkZXYpCiAJcmV0dXJuIGVycm9yOwogfQogCi1z
dGF0aWMgY29uc3Qgc3RydWN0IGRldl9wYWdlbWFwX29wcyBwY2lfcDJwZG1hX3BhZ2VtYXBfb3Bz
ID0gewotCS5raWxsCQk9IHBjaV9wMnBkbWFfcGVyY3B1X2tpbGwsCi0JLmNsZWFudXAJPSBwY2lf
cDJwZG1hX3BlcmNwdV9jbGVhbnVwLAotfTsKLQogLyoqCiAgKiBwY2lfcDJwZG1hX2FkZF9yZXNv
dXJjZSAtIGFkZCBtZW1vcnkgZm9yIHVzZSBhcyBwMnAgbWVtb3J5CiAgKiBAcGRldjogdGhlIGRl
dmljZSB0byBhZGQgdGhlIG1lbW9yeSB0bwpAQCAtMTcxLDcgKzEzNCw2IEBAIHN0YXRpYyBjb25z
dCBzdHJ1Y3QgZGV2X3BhZ2VtYXBfb3BzIHBjaV9wMnBkbWFfcGFnZW1hcF9vcHMgPSB7CiBpbnQg
cGNpX3AycGRtYV9hZGRfcmVzb3VyY2Uoc3RydWN0IHBjaV9kZXYgKnBkZXYsIGludCBiYXIsIHNp
emVfdCBzaXplLAogCQkJICAgIHU2NCBvZmZzZXQpCiB7Ci0Jc3RydWN0IHAycGRtYV9wYWdlbWFw
ICpwMnBfcGdtYXA7CiAJc3RydWN0IGRldl9wYWdlbWFwICpwZ21hcDsKIAl2b2lkICphZGRyOwog
CWludCBlcnJvcjsKQEAgLTE5NCwyMiArMTU2LDEyIEBAIGludCBwY2lfcDJwZG1hX2FkZF9yZXNv
dXJjZShzdHJ1Y3QgcGNpX2RldiAqcGRldiwgaW50IGJhciwgc2l6ZV90IHNpemUsCiAJCQlyZXR1
cm4gZXJyb3I7CiAJfQogCi0JcDJwX3BnbWFwID0gZGV2bV9remFsbG9jKCZwZGV2LT5kZXYsIHNp
emVvZigqcDJwX3BnbWFwKSwgR0ZQX0tFUk5FTCk7Ci0JaWYgKCFwMnBfcGdtYXApCisJcGdtYXAg
PSBkZXZtX2t6YWxsb2MoJnBkZXYtPmRldiwgc2l6ZW9mKCpwZ21hcCksIEdGUF9LRVJORUwpOwor
CWlmICghcGdtYXApCiAJCXJldHVybiAtRU5PTUVNOwotCi0JaW5pdF9jb21wbGV0aW9uKCZwMnBf
cGdtYXAtPnJlZl9kb25lKTsKLQllcnJvciA9IHBlcmNwdV9yZWZfaW5pdCgmcDJwX3BnbWFwLT5y
ZWYsCi0JCQlwY2lfcDJwZG1hX3BlcmNwdV9yZWxlYXNlLCAwLCBHRlBfS0VSTkVMKTsKLQlpZiAo
ZXJyb3IpCi0JCWdvdG8gcGdtYXBfZnJlZTsKLQotCXBnbWFwID0gJnAycF9wZ21hcC0+cGdtYXA7
Ci0KIAlwZ21hcC0+cmVzLnN0YXJ0ID0gcGNpX3Jlc291cmNlX3N0YXJ0KHBkZXYsIGJhcikgKyBv
ZmZzZXQ7CiAJcGdtYXAtPnJlcy5lbmQgPSBwZ21hcC0+cmVzLnN0YXJ0ICsgc2l6ZSAtIDE7CiAJ
cGdtYXAtPnJlcy5mbGFncyA9IHBjaV9yZXNvdXJjZV9mbGFncyhwZGV2LCBiYXIpOwotCXBnbWFw
LT5yZWYgPSAmcDJwX3BnbWFwLT5yZWY7CiAJcGdtYXAtPnR5cGUgPSBNRU1PUllfREVWSUNFX1BD
SV9QMlBETUE7CiAJcGdtYXAtPnBjaV9wMnBkbWFfYnVzX29mZnNldCA9IHBjaV9idXNfYWRkcmVz
cyhwZGV2LCBiYXIpIC0KIAkJcGNpX3Jlc291cmNlX3N0YXJ0KHBkZXYsIGJhcik7CkBAIC0yMjMs
NyArMTc1LDcgQEAgaW50IHBjaV9wMnBkbWFfYWRkX3Jlc291cmNlKHN0cnVjdCBwY2lfZGV2ICpw
ZGV2LCBpbnQgYmFyLCBzaXplX3Qgc2l6ZSwKIAllcnJvciA9IGdlbl9wb29sX2FkZF9vd25lcihw
ZGV2LT5wMnBkbWEtPnBvb2wsICh1bnNpZ25lZCBsb25nKWFkZHIsCiAJCQlwY2lfYnVzX2FkZHJl
c3MocGRldiwgYmFyKSArIG9mZnNldCwKIAkJCXJlc291cmNlX3NpemUoJnBnbWFwLT5yZXMpLCBk
ZXZfdG9fbm9kZSgmcGRldi0+ZGV2KSwKLQkJCSZwMnBfcGdtYXAtPnJlZik7CisJCQlwZ21hcC0+
cmVmKTsKIAlpZiAoZXJyb3IpCiAJCWdvdG8gcGFnZXNfZnJlZTsKIApAQCAtMjM1LDcgKzE4Nyw3
IEBAIGludCBwY2lfcDJwZG1hX2FkZF9yZXNvdXJjZShzdHJ1Y3QgcGNpX2RldiAqcGRldiwgaW50
IGJhciwgc2l6ZV90IHNpemUsCiBwYWdlc19mcmVlOgogCWRldm1fbWVtdW5tYXBfcGFnZXMoJnBk
ZXYtPmRldiwgcGdtYXApOwogcGdtYXBfZnJlZToKLQlkZXZtX2tmcmVlKCZwZGV2LT5kZXYsIHAy
cF9wZ21hcCk7CisJZGV2bV9rZnJlZSgmcGRldi0+ZGV2LCBwZ21hcCk7CiAJcmV0dXJuIGVycm9y
OwogfQogRVhQT1JUX1NZTUJPTF9HUEwocGNpX3AycGRtYV9hZGRfcmVzb3VyY2UpOwotLSAKMi4y
MC4xCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpOb3V2
ZWF1IG1haWxpbmcgbGlzdApOb3V2ZWF1QGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xp
c3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL25vdXZlYXU=
